<!DOCTYPE html>
<html>
  <head>
    <base target="_self">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CPanel Dashboard</title>
	<!-- CSS  
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  -->
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link href="https://pmcctg.web.app/css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-alpha.4/css/materialize.min.css">
  <script type = "text/javascript" src = "https://code.jquery.com/jquery-2.1.1.min.js"></script>           
<!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-alpha.4/js/materialize.min.js"></script>
    
    <link rel="stylesheet" href="https://pmcctg.web.app/css/pdf.css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.js"></script>
    <!--
    <script src="https://pmcctg.web.app/js/pdf.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/polyfills.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.2.7/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.5/jspdf.min.js"></script> -->
  
  </head>
  <body>
    <div class="row">
    <p>Helloo <b><?= name ?></b>,<b><?= hash ?></b></p>
    <!-- <a href="<?= ScriptApp.getService().getUrl(); ?>?v=out" class="btn waves-effect waves-light">Logout
          <i class="material-icons right">exit_to_app</i> 
    </a> -->
    <button class="btn waves-effect waves-light" id="logout">Log Out
          <i class="material-icons right">exit_to_app</i> 
    </button>
      <button class="btn waves-effect waves-light" id="btn">New Entry
          <i class="material-icons right">edit</i> 
      </button>
      <button class="btn waves-effect waves-light" id="btnp">Print
          <i class="material-icons right">print</i> 
      </button>
      <button class="btn waves-effect waves-light" id="btnptlist">List
          <i class="material-icons right">list</i> 
      </button></div>
    <div id="wait" style="display:none;"><div class="row">
      <div class="col s12 m6">
        <div class="card blue-grey darken-1">
        <div class="card-content white-text">
          <span class="card-title">New Entry</span>
          <!-- <div class="right-align">
          <button class="btn waves-effect waves-light" id="cls"><i class="material-icons right">cancel</i></button></div> -->
          <div class="row">
            <div class="input-field col s6">
              <input value="" id="tel_no" type="text" class="validate">
              <label for="tel_no">Search</label>
            </div>
            <div class="input-field col s2">
              <button class="btn waves-effect waves-light" id="numsearch"><i class="material-icons right">search</i></button>
            </div>
            <div class="input-field col s4">
              <button class="btn waves-effect waves-light" id="cls"><i class="material-icons right">cancel</i></button>
            </div>
           </div>
           <div class="row">
            <div class="input-field col s6">
              <input disabled value="" id="mr_no" type="text" class="validate">
              <label for="mr_no"></label>
            </div>
            <!--
            <div class="input-field col s6">
              <input disabled value="Auto Pick after submit" id="entrytime" type="text" class="validate">
              <label for="disabled">Entry time</label>
            </div> -->
            <div class="input-field col s8">
              <input id="pt_name" type="text" class="validate">
              <label for="pt_name">Name</label>
            </div>
            <div class="input-field col s4">
              <input id="pt_age" type="number" class="validate">
              <label for="pt_age">Age</label>
            </div>
            <div class="input-field col s6">
              <i class="material-icons prefix">phone</i>
              <input id="pt_tel" type="tel" class="validate">
              <label for="pt_tel">Telephone</label>
            </div>
            <div class="input-field col s6">
              <i class="material-icons prefix">assignment_ind</i>
              <input disabled value="<?= name ?>" id="staff" type="text" class="validate">
              <label for="staff">Staff Name</label>
            </div>
            <div class="input-field col s12">
              <!-- <input id="dr_name" type="text" class="validate">
              <label for="dr_name">Referred Doctor</label> -->
              <input type="text" id="dr_name" class="autocomplete">
              <label for="dr_name">Referred Doctor</label>
            </div>
            <div class="input-field col s6">
              <select id="itemSelect" multiple>
                <option value="" disabled selected></option>
                <option value="SWD">SWD</option>
                <option value="SWD1">SWD 1</option>
                <option value="UST">UST</option>
                <option value="UST1">UST 1</option>
                <option value="UST2">UST 2</option>
                <option value="EST">EST</option>
                <option value="EST1">EST 1</option>
                <option value="TENS">TENS</option>
                <option value="TENS1">TENS 1</option>
                <option value="TENS2">TENS 2</option>
                <option value="C.TRACTION">C.TRACTION</option>
                <option value="L.TRACTION">L.TRACTION</option>
                <option value="IFT">IFT</option>
                <option value="IFT1">IFT 1</option>
                <option value="IFT2">IFT 2</option>
              </select>
              <label>Name of Therapy</label>
            </div>
            <div class="input-field col s6">
              <input id="id_amount" type="number" class="validate">
              <label for="id_amount">Amount</label>
            </div>
            </div>
          <button class="btn waves-effect waves-light" id="add">Submit
            <i class="material-icons right">send</i>
          </button>
        </div>
        <div class="card-action">
          
        </div>
        </div>
      </div>
      </div>
    </div>
    <div id="printw" style="display:none;">
    <div id="try1">
    <!-- <table style="width:600px">
      <tr>
      <td style="width:50%">Money Receipt No : <label id="mrno">mr_no</label></td>
      <td style="width:50%">Date : <label id="mdate">12/12/12222</label></td>
      </tr>
      <tr>
      <td style="width:60%">Patient Name : <label id='ptid'>Jackson</label></td>
      <td style="width:40%">Age : <label id='ptage'>94</label></td>
      </tr>
      <tr>
      <td colspan="2">Contact Number : <label id='telno'>01234567890</label></td>
      </tr>
      <tr>
      <td colspan="2">Name of Referred Doctor : <label id='refdr'>Name of Referred Doctor : </label></td>
      </tr>
      </table><br>
        <table style="width:600px" id="maintable">
        <tr><th style="width:20px">No</th><th>Name of therapy</th><th style="width:20px">Amount</th></tr>
        </table> -->
        
        <div class="card" id="invoice">
			<div class="card-body">
				<div style="width:90%; float: left;text-align:left;position: absolute;word-wrap: break-word;">
					<b  id="mrno">Money Receipt No :</b></li>
					<li id='ptid'>Patient Name : MUHAMMAD SHAHADAT HOSSAIN/li>
					<li id='ptage'>Age : 52</li>
					<li id='refdr'>Name of Referred Doctor : MD SHAHADAT HOSSAIN MD SHAHADAT HOSSAIN MD SHAHADAT HOSSAIN</li>
				</div>
				<div style="width:50%; float: right;text-align:right;position: relative;">
						<b id="mdate">WEDNESDAY 12 PM 12 MARCH 2021</b><br><br>
						<li id='telno'>Contact Number: 012345678900</li>
				</div>
			</div>			
			<div class="card-body">
                 <table style="width:100%;padding-top:10px;">
					<thead><tr><th style='width:20px'>No</th><th>Name of therapy</th><th style='width:40px;text-align:right'>Amount</th></tr></thead>
					<tbody id="maintable"></tbody>
				</table>
            </div>					
			<div class="card-body">                                
				<table style="width:50%;float: right;"><tbody id="maintable1"></tbody></table>
                <div style="width:50%;float: left;"><div style="height:100%;padding-top:30px;font: 20px Arial, Helvetica, sans-serif;">
				<b style="border-style: solid;padding:10px;">PAID</b></div></div>
			</div>
            <div style="padding-left:25px;"><b id='inwords'>In Words: Two Hundred Taka only forty two minus</b></div>       
			<div style="padding-left:25px;padding-top:10px;padding-bottom:10px;" id='staffid'>Staff Nname : Ekram</div>
        </div><br>
					
		<button class="btn waves-effect waves-light" id="download">Printt</button> 
    
    </div><br>
    <!-- <form id="form1">
    <input type="button" value="Print this" id="btnPrint" />
    </form> -->
    </div>
    <!-- <style>
    table,th,td {
    border:1px solid black;border-collapse: collapse;
    }
    th, td {
    text-align: left;}</style> -->
    <div id="ptlist" style="display:none;">
    <div><button class="btn waves-effect waves-light" id="ptload">Load</button></div>
    <table style="width:800px;padding-top:10px;" id="maintable9"></table>
    </div>

    <script>
    var d1,d2,d3,d4,d5,d6,d7,d8,d9;
    var d10='00';
    
    $('#btnptlist').on('click',function(){
       $('#printw').hide();$('#wait').hide();$('#ptlist').show();//$("#maintable9").empty();
       //google.script.run.withSuccessHandler(populatealldata).getData();
    });
    
    $('#ptload').on('click',function(){
       $("#maintable9").empty();google.script.run.withSuccessHandler(populatealldata).getData();
    });

    $('#btnp').on('click',function(){
      $('#printw').show();$('#wait').hide();$('#ptlist').hide();$("#maintable").empty();$("#maintable1").empty();

      $('#mrno').text('Money Receipt No : '+d1);$('#mdate').text('Date : '+d2);
      $('#ptid').text('Patient Name : '+d3);$('#ptage').text('Age : '+d4);
      $('#telno').text('Contact Number: '+d5);$('#refdr').text('Name of Referred Doctor : '+d7);
      $('#staffid').text('Staff Name : '+d6);
      $('#inwords').text('In Words: '+inWords(d9));
      var list = d8.split(",");
      for (var i=0;i<list.length;i++){
        //$("#maintable").append("<tr><td style='width:20px'>" + (i+1) + "</td><td>" + list[i] + "</td><td style='width:40px'>200</td></tr>");
        $("#maintable").append("<tr><td>" + (i+1) + "</td><td>" + list[i] + "</td><td style='width:40px;text-align:right'><span>200</span></td></tr>");
      }

      //$("#maintable").append("<tr><td colspan='2' style='text-align: right;'>Total Amount</td><td style='width:40px'>" + (200 * list.length) + "</td></tr>");
      //$("#maintable").append("<tr><td colspan='2' style='text-align: right;'>Disc.</td><td style='width:40px'>" + ((200 * list.length)-d9) + "</td></tr>");
      //$("#maintable").append("<tr><td colspan='2' style='text-align: right;'>Total Payable</td><td style='width:40px'>" + d9 + "</td></tr>");
      //$("#maintable").append("<tr><td colspan='2' style='text-align: right;'>Due</td><td style='width:40px'>0</td></tr>");
      //$("#maintable").append("<tr><td colspan='3'><b>In Words: <label>" + inWords(d9) + "</label></b></td></tr>");
      //$("#maintable").append("<tr><td colspan='3'><b>Entry Staff Id: <label>" + d6 + "</label></b></td></tr>");
      
      $("#maintable1").append("<tr><th>Total Amount:</th><td style='width:40px;text-align:right;'>" + (200 * list.length) + "</td></tr>");
      $("#maintable1").append("<tr><th>Disc.: </th><td style='width:40px;text-align:right;'>" + ((200 * list.length)-d9) + "</td></tr>");
      $("#maintable1").append("<tr><th>Total Payable:</th><td style='width:40px;text-align:right;'>" + d9 + "</td></tr>");
	  $("#maintable1").append("<tr><th><b>Due : </b></th><td style='width:40px;text-align:right'>0</td></tr>");
	  //$("#maintable1").append("<tr><th class='text-left'><b>In Words: <label>" + inWords(d9) + "</label></b></td></tr>");
    });
    
    $(document).ready(function(){
        $('select').formSelect();
    });

    function populatename(values){
      console.log(values);
      $('#dr_name').autocomplete({ data:values});
    }

    function populateserial(values){
      $('#mr_no').val(values);
    }

    function populatedata(values){
      $('#dr_name').val(values[3]);$('#id_amount').val(values[5]);$('#itemSelect').prop('selectedIndex',0);
      $('#pt_name').val(values[0]);$('#pt_age').val(values[1]);$('#pt_tel').val(values[2].toString());
      var list = values[4].split(",");
      $.each(list,function(i,e){
          $("#itemSelect option[value='"+e+"']").prop("selected",true);
      });
      M.updateTextFields();$('#itemSelect').formSelect();
    }
    
    function populatealldata(listt){
    //console.log(JSON.parse(listt));
    var list = JSON.parse(listt);
        for (var i=0;i<list.length - 1;i++){
        var myDate = new Date(list[i][1]);var d11 = myDate.toLocaleString();
            $("#maintable9").append("<tr id='ptid"+i+"'><td style='width:5%;'>"+list[i][0]+"</td><td style='width:10%;'>"+d11+"</td><td  style='width:5%;'>"+list[i][2]+"</td>"+
            "<td style='width:5%;'>"+list[i][3]+"</td><td style='width:10%;'>"+list[i][4]+"</td><td style='width:10%;'>"+list[i][5]+"</td><td style='width:10%;'>"+
            list[i][6]+"</td><td style='width:10%;'>"+list[i][7]+"<td style='width:5%;'>"+list[i][8]+
            "</td><td style='width:5%;'><button class='btn waves-effect waves-light' onClick='PtData(" + i + ")' id='ptbtn"+i+"'>Add</button></td></tr>");
            //$(document).on('click', '#ptbtn'+i, function() {
			//		PtData(i);
			//	});
        }
    }

    $('#numsearch').on('click',function(){
      google.script.run.withSuccessHandler(populatedata).rowOfNum($('#tel_no').val());
    });  

    $('#btn').on('click',function(){
      $('#wait').show();$('#printw').hide();$('#ptlist').hide();
      google.script.run.withSuccessHandler(populateserial).getSerial();
      google.script.run.withSuccessHandler(populatename).getList();
    });

    $('#cls').on('click',function(){
      $('#itemSelect').prop('selectedIndex',0);$('#itemSelect').formSelect();
      $('#mr_no').val('');$('#pt_name').val('');$('#pt_age').val('');$('#pt_tel').val('');
      $('#dr_name').val('');$('#tel_no').val('');
      $('#id_amount').val('');
      $('#wait').fadeOut();M.updateTextFields();
      //$('#wait').hide();
    });
    
    $('#logout').on('click',function(){
      //window.parent.location.reload();
      //document.getElementById('homeid').contentWindow.location.reload();
    });

    $('#add').on('click',function(){
      //alert($('#itemSelect').val());
      if ($('#mr_no').val().length <1 ){
        M.toast({html: 'Empty Money Receipt Number.'});return;
      }else if ($('#pt_name').val().length <1 ){
        M.toast({html: 'Empty Patient name.'});return;
      }else if ($('#pt_tel').val().length <1 ){
        M.toast({html: 'Empty Telephone Number.'});return;
      }else if ($('#dr_name').val().length <1 ){
        M.toast({html: 'Empty Referred Doctor Name.'});return;
      }else if ($('#itemSelect').val().length <1 ){
        M.toast({html: 'Empty Therapy Name.'});return;
      }else if ($('#id_amount').val().length <1 ){
        M.toast({html: 'Empty Amount.'});return;
      }

      google.script.run.withSuccessHandler(function(output){
        if (output == 'ok'){
          d1 = $('#mr_no').val();d2 = new Date().toString();
          d3 = $('#pt_name').val(); d4 = $('#pt_age').val();
          d5 = $('#pt_tel').val();  d6 = $('#staff').val();
          d7 = $('#dr_name').val(); d8 = $('#itemSelect').val().toString();
          d9 = $('#id_amount').val();
          $('#itemSelect').prop('selectedIndex',0);$('#itemSelect').formSelect();
          $('#mr_no').val('');$('#pt_name').val('');$('#pt_age').val('');$('#pt_tel').val('');
          $('#dr_name').val('');$('#id_amount').val('');$('#tel_no').val('');
          $('#wait').fadeOut();M.toast({html: 'Entry done.'});M.updateTextFields();
        }
      }).appendRow($('#mr_no').val(),'',$('#pt_name').val(),$('#pt_age').val(),$('#pt_tel').val(),$('#staff').val(),$('#dr_name').val(),$('#itemSelect').val().toString(),$('#id_amount').val());
    });
    
    $("#btnPrint").on("click", function () { 
        });
        
        function PtData(i){
        //$("'#ptid'+i td:eq(2)")
        var date = new Date($('#ptid'+i+' td:eq(1)').text());
        var weekdays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun","Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        var weekday = weekdays[date.getDay()];
        var month = monthNames[date.getMonth()];
        var year = date.getFullYear();
            d1 = $('#ptid'+i+' td:eq(0)').text(); d2 = weekday+' '+ ((date.getDate() > 9) ? date.getDate() : ('0' + date.getDate()))+'-'+month+'-'+year;
            d3 = $('#ptid'+i+' td:eq(2)').text(); d4 = $('#ptid'+i+' td:eq(3)').text();
            d5 = $('#ptid'+i+' td:eq(4)').text(); d6 = $('#ptid'+i+' td:eq(5)').text();
            d7 = $('#ptid'+i+' td:eq(6)').text(); d8 = $('#ptid'+i+' td:eq(7)').text();
            d9 = $('#ptid'+i+' td:eq(8)').text();
            console.log(i);M.toast({html: 'Entry Loaded. Click to Print'});
        }
        
    function inWords(num) {
      var a = ['','One ','Two ','Three ','Four ', 'Five ','Six ','Seven ','Eight ','Nine ','Ten ','Eleven ','Twelve ','Thirteen ','Fourteen ','Fifteen ','Sixteen ','Seventeen ','Eighteen ','Nineteen '];
    var b = ['', '', 'Twenty','Thirty','Forty','Fifty', 'Sixty','Seventy','Eighty','Ninety'];

      if ((num = num.toString()).length > 9) return 'overflow';
      n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
      if (!n) return; var str = '';
      str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'crore ' : '';
      str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'lakh ' : '';
      str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'thousand ' : '';
      str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'hundred ' : '';
      str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) + 'only ' : '';
      return str;
      }
    
    document.getElementById("download")
        .addEventListener("click", () => {
            const invoice = this.document.getElementById("invoice");
            console.log(invoice);
            console.log(window);
            var opt = {
                margin: 1,
                filename: 'myfile.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging:true, allowTaint: false },
                jsPDF: { unit: 'mm', format: 'a6', orientation: 'portrait' }
            };
            //html2pdf().from(invoice).set(opt).save();format: [8, 8]
			html2pdf().from(invoice).set(opt).output("bloburl").then(function (pdf) {
				setTimeout(function () {
					console.log(pdf);
					//var iframe = document.getElementById('sample-pdf');
					//iframe.src = pdf;
					window.open(pdf, '_blank');
				},2000);
			});
        })
    
    </script>

  </body>
</html>
